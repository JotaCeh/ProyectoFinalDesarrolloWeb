<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Codifica con Guali</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Codifica con Guali</h1>
        <div class="main-content">
            <div class="tablero-container">
                <div id="tablero"></div>
                <div class="controls">
                    <button class="btn up"></button>
                    <button class="btn left"></button>
                    <button class="btn right"></button>
                    <button class="btn down"></button>
                </div>
                <div class="bottom-bar">
                    <button class="ejecutar">Ejecutar</button>
                    <button class="reiniciar">Reiniciar</button>
                    <button class="configurar">Configurar</button>
                </div>
            </div>
            <div class="panel-lateral">
                <select class="comandos">
                    <option>Comando Seleccionados</option>
                </select>
                <div class="movimientos">
                    <p>Movimientos</p>
                </div>
                
                <!-- Imagen decorativa de robot -->
                <div class="robot-img"></div>
                

            </div>
            
        </div>
        
    </div>
<script>
/* ---------- Datos del tablero ---------- */
const filas = 5;
const columnas = 5;

let matrizGuardada = localStorage.getItem('pistaGuardada');
let matriz = matrizGuardada
  ? JSON.parse(matrizGuardada)
  : [
      [0, 0, 0, 0, 0],
      [0, 1, 1, 1, 0],
      [0, 1, 0, 1, 0],
      [0, 1, 0, 1, 0],
      [2, 1, 0, 0, 0]
    ];

/* ---------- Variables globales ---------- */
const tablero = document.getElementById('tablero');
tablero.innerHTML = '';

let robotFila = 0;
let robotCol = 0;
let inicioFila = 0;
let inicioCol = 0;

const queue = []; // Cola de comandos
const celdas = [];
const movimientosDiv = document.querySelector('.movimientos');

/* ---------- Crear tablero visual ---------- */
for (let i = 0; i < filas; i++) {
  for (let j = 0; j < columnas; j++) {
    const cell = document.createElement('div');
    cell.classList.add('celda');
    if (matriz[i][j] === 1) cell.classList.add('verde');
    if (matriz[i][j] === 2) {
      cell.classList.add('inicio');
      cell.textContent = ''; 
      inicioFila = i;
      inicioCol = j;
      robotFila = i;
      robotCol = j;
      cell.classList.add('robot');
      // Mostrar "INICIO"
      const spanInicio = document.createElement('span');
      spanInicio.textContent = 'INICIO';
      spanInicio.style.fontSize = '9px';
      spanInicio.style.position = 'absolute';
      spanInicio.style.top = '2px';
      spanInicio.style.left = '2px';
      spanInicio.style.color = '#0a0';
      cell.appendChild(spanInicio);
      cell.style.position = 'relative';
    }
    tablero.appendChild(cell);
    celdas.push(cell);
  }
}

/* ---------- Helpers UI movimientos ---------- */
function resetMovimientosUI() {
  movimientosDiv.innerHTML = '<p>Movimientos</p>';
}
function appendMovimientoQueued(texto) {
  const p = document.createElement('p');
  p.textContent = texto;
  p.classList.add('queued');
  movimientosDiv.appendChild(p);
}
function queueCommand(nombre) {
  queue.push(nombre);
  appendMovimientoQueued(nombre);
}

/* ---------- Flechas solo encolan ---------- */
document.querySelector('.btn.up').addEventListener('click', () => queueCommand('mover_arriba'));
document.querySelector('.btn.down').addEventListener('click', () => queueCommand('mover_abajo'));
document.querySelector('.btn.left').addEventListener('click', () => queueCommand('mover_izquierda'));
document.querySelector('.btn.right').addEventListener('click', () => queueCommand('mover_derecha'));

/* ---------- Deshabilitar controles ---------- */
function setControlsDisabled(value) {
  document.querySelectorAll('.btn.up, .btn.down, .btn.left, .btn.right').forEach(b => b.disabled = value);
  document.querySelector('.ejecutar').disabled = value;
  document.querySelector('.reiniciar').disabled = value;
  document.querySelector('.configurar').disabled = value;
}

/* ---------- Movimiento real ---------- */
function canStepTo(fila, col) {
  if (fila < 0 || fila >= filas || col < 0 || col >= columnas) return false;
  const v = matriz[fila][col];
  return v === 1 || v === 2;
}

function moveRobotTo(nf, nc) {
  celdas[robotFila * columnas + robotCol].classList.remove('robot');
  robotFila = nf;
  robotCol = nc;
  celdas[robotFila * columnas + robotCol].classList.add('robot');
}

/* ---------- Modal Derrota ---------- */
function mostrarModalDerrota() {
  const modal = document.getElementById('modalDerrota');
  modal.style.display = 'flex';
  document.getElementById('cerrarModal').onclick = () => {
    modal.style.display = 'none';
    reiniciarRobot();
  };
}

/* ---------- Modal Victoria ---------- */
function mostrarModalVictoria() {
  const modal = document.getElementById('modalVictoria');
  modal.style.display = 'flex';
  document.getElementById('cerrarVictoria').onclick = () => {
    modal.style.display = 'none';
    reiniciarRobot();
  };
}

/* ---------- Ejecutar cola ---------- */
async function ejecutarCola() {
  if (queue.length === 0) return;
  setControlsDisabled(true);
  const listaP = () => movimientosDiv.querySelectorAll('p');

  const pistaGuardada = JSON.parse(localStorage.getItem('pistaVerde'));
  const final = pistaGuardada?.final;

  for (let i = 0; i < queue.length; i++) {
    const cmd = queue[i];
    const p = listaP()[i + 1];
    if (p) { p.classList.remove('queued'); p.classList.add('current'); }

    let nf = robotFila, nc = robotCol;
    if (cmd === 'mover_arriba') nf--;
    if (cmd === 'mover_abajo') nf++;
    if (cmd === 'mover_izquierda') nc--;
    if (cmd === 'mover_derecha') nc++;

    if (!canStepTo(nf, nc)) {
      if (p) { p.classList.remove('current'); p.classList.add('failed'); }
      mostrarModalDerrota();
      break;
    }

    moveRobotTo(nf, nc);
    if (p) { p.classList.remove('current'); p.classList.add('done'); }

    // Verificar victoria
    if (final && robotFila === final[0] && robotCol === final[1]) {
      mostrarModalVictoria();
      break;
    }

    await new Promise(r => setTimeout(r, 1000));
  }
  setControlsDisabled(false);
}

/* ---------- Botones ---------- */
document.querySelector('.ejecutar').addEventListener('click', ejecutarCola);
document.querySelector('.reiniciar').addEventListener('click', reiniciarRobot);
document.querySelector('.configurar').addEventListener('click', () => {window.location.href = 'configurar.html';});


/* ---------- Reiniciar robot y movimientos ---------- */
function reiniciarRobot() {
  queue.length = 0;
  resetMovimientosUI();
  celdas.forEach(c => c.classList.remove('robot'));
  robotFila = inicioFila;
  robotCol = inicioCol;
  celdas[robotFila * columnas + robotCol].classList.add('robot');
}

/* ---------- Inicial ---------- */
resetMovimientosUI();

/* ---------- Manejo de pistas y final ---------- */
const pistas = JSON.parse(localStorage.getItem('pistas') || '[]');
let pistaActualIndex = 0;
if (pistas.length > 0) {
  // Elegir pista aleatoria
  pistaActualIndex = Math.floor(Math.random() * pistas.length);
  cargarPista(pistaActualIndex);
}

function cargarPista(index) {
  matriz = Array(filas).fill(0).map(()=>Array(columnas).fill(0));

  celdas.forEach(c => {
    c.classList.remove('verde','final');
    // Limpiar texto de la celda, salvo el INICIO
    const spanInicio = c.querySelector('span');
    if (!spanInicio) c.textContent = '';
  });

  const pista = pistas[index];
  if (!pista) return;

  // Camino
  pista.camino.forEach(([f,c]) => {
    matriz[f][c] = 1;
    celdas[f*columnas + c].classList.add('verde');
  });

  // Celda final
  const [ff, fc] = pista.final;
  matriz[ff][fc] = 1;
  const celdaFinal = celdas[ff*columnas + fc];
  celdaFinal.classList.add('final');
  celdaFinal.textContent = 'FINAL';
}


// Botón cambiar pista
const btnCambiar = document.createElement('button');
btnCambiar.textContent = 'Cambiar pista';
btnCambiar.id = 'cambiarPista';
document.querySelector('.panel-lateral').appendChild(btnCambiar);

btnCambiar.addEventListener('click', () => {
  if (pistas.length <= 1) {
    alert('Solo hay una pista disponible');
    return;
  }
  let nuevo;
  do { nuevo = Math.floor(Math.random() * pistas.length); } while (nuevo === pistaActualIndex);
  pistaActualIndex = nuevo;
  cargarPista(pistaActualIndex);
  reiniciarRobot();
});

// Cargar la primera pista automáticamente
if (pistas.length > 0) {
  cargarPista(pistaActualIndex);
}
</script>


<div id="modalVictoria" class="modal-derrota">
  <div class="modal-contenido">
    <img src="./images/robot_decorativo.png" class="robot-modal-img">
    <h2>¡Ganaste!</h2>
    <button id="cerrarVictoria">Cerrar</button>
  </div>
</div>

<!-- Modal de derrota -->
<div id="modalDerrota" class="modal-derrota">
  <div class="modal-contenido">

    <h2>¡Perdiste!</h2>
    <button id="cerrarModal">Cerrar</button>
  </div>
</div>

</body>
</html>

